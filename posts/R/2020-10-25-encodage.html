---
title: "L'encodage de caractÃ¨re"
subtitle: "Comprendre et utiliser l'encodage dans Rstudio"
author: Rodrigue EDORH
date: 2020-10-25
slug: encoding
categories: ["R"]
tags: ["R Markdown"]
---



<div id="lencodage-de-caractÃ¨re-cest-quoi" class="section level1">
<h1>Lâ€™encodage de caractÃ¨re câ€™est quoi ?</h1>
<p>Un ordinateur ne peut stocker que des nombres, ou plus prÃ©cisÃ©ment des 0 et des 1 (des Â« bits Â») quâ€™on regroupe pour former des nombres en binaire.</p>
<p>Comment fait-on alors pour Ã©crire du texte ? La rÃ©ponse est toute bÃªte : on associe Ã  chaque caractÃ¨re (une lettre, un signe de ponctuation, une espaceâ€¦) un nombre. Un texte est alors une suite de ces nombres, on parle de chaÃ®ne de caractÃ¨res.</p>
<p>Lâ€™<a href="https://fr.wikipedia.org/wiki/Codage_des_caract%C3%A8res">encodage</a> est une table de correspondance entre un ordinateur et le langage humain (franÃ§ais, anglais, chinoisâ€¦).</p>
<blockquote>
<p>Si vous voulez aller plus loin sur lâ€™encodage et son histoire, nous vous recommandons ce tutoriel : <a href="http://sdz.tdct.org/sdz/comprendre-les-encodages.html">Comprendre les encodages</a>.</p>
</blockquote>
</div>
<div id="utf-8-lencodage-rÃ©fÃ©rence" class="section level1">
<h1>UTF-8: lâ€™encodage rÃ©fÃ©rence</h1>
<p>Au fil des annÃ©es plusieurs encodages ont Ã©tÃ© crÃ©Ã©s. Un a finalement rÃ©ussi Ã  regrouper presque tous les langages. Il sâ€™agit de Lâ€™<a href="https://fr.wikipedia.org/wiki/Unicode">Unicode</a>. Il y a plusieurs implÃ©mentations concrÃ¨tes dâ€™Unicode. Le plus cÃ©lÃ¨bre est â€œUTF-8â€. Lâ€™<a href="https://fr.wikipedia.org/wiki/UTF-8">UTF-8</a> est le seul encodage vers lequel, aujourdâ€™hui, on puisse convertir vers et depuis (pratiquement) toutes les langues au monde.</p>
<p>Suivant le systÃ¨me dâ€™exploitation que vous utilisez, lâ€™encodage par dÃ©faut nâ€™est pas le mÃªme.</p>
<p>Par exemple, les systÃ¨mes dâ€™exploitation <strong>Linux</strong> utilisent en gÃ©nÃ©ral par dÃ©faut lâ€™encodage <strong>UTF-8</strong>. Par contre sous Windows lâ€™encodage par dÃ©faut est gÃ©nÃ©ralement <strong>Windows 1252</strong>.</p>
</div>
<div id="lencodage-sur-linux" class="section level1">
<h1>Lâ€™encodage sur Linux</h1>
<p>Si vous travailler avec des VM notamment via des plateformes clous (CGP, AWS, AZUREâ€¦), il y a de fortes chances que vous travaillez sous Linux. Par consÃ©quent lâ€™encodage par dÃ©faut est <strong>UTF-8</strong>. Ceci implique que lors de lâ€™importation ou de lâ€™exportation des donnÃ©es, les caractÃ¨res seront encodÃ©s par dÃ©faut en UTF-8.</p>
</div>
<div id="illustration-des-problÃ¨mes-liÃ©s-Ã -lencodage-sur-les-donnÃ©es" class="section level1">
<h1>Illustration des problÃ¨mes liÃ©s Ã  lâ€™encodage sur les donnÃ©es</h1>
<div id="exemple-1-vm-linux-vers-excel-bureau" class="section level2">
<h2>Exemple 1 : VM Linux vers Excel Bureau</h2>
<p>Construisons une table depuis notre environnement Linux avec des caractÃ¨res spÃ©ciaux:</p>
<pre class="r"><code>df &lt;- tibble::tibble(nom = c(&quot;Ã‰ric&quot;, &quot;NathanÃ«l&quot;), entreprise = c(&quot;RÃ©seau de Transport d&#39;Ã©lectricitÃ©&quot;, &quot;RÃ©seau de Transport d&#39;Ã©lectricitÃ©&quot;))
df</code></pre>
<pre><code>## # A tibble: 2 x 2
##   nom      entreprise                       
##   &lt;chr&gt;    &lt;chr&gt;                            
## 1 Ã‰ric     RÃ©seau de Transport d&#39;Ã©lectricitÃ©
## 2 NathanÃ«l RÃ©seau de Transport d&#39;Ã©lectricitÃ©</code></pre>
<p>Sauvegardons notre table dans un csv.</p>
<pre class="r"><code>readr::write_csv2(df, &quot;df.csv&quot;)</code></pre>
<p>Exportons ensuite le fichier vers notre poste windows (Onglet <strong>Files</strong> puis <strong>More &gt; Export</strong>) et ouvrons le dans excel en double-cliquant sur le fichier.</p>
<p>Normalement la table ressemble Ã  ca:</p>
<p><img src="/images/post-rmarkdown/encodage_linux_windows.png" /></p>
<p>Les caractÃ¨res spÃ©ciaux ont Ã©tÃ© transformÃ©s en des caractÃ¨res â€œbizarresâ€.</p>
</div>
<div id="exemple-2-excel-bureau-vers-linux" class="section level2">
<h2>Exemple 2: Excel Bureau vers Linux</h2>
<p>CrÃ©ons un fichier csv depuis excel sur notre poste bureautique avec des caractÃ¨res spÃ©ciaux.
<img src="/images/post-rmarkdown/encodage_windows_linux.png" /></p>
<p>On le tÃ©lÃ©charge sur Rstudio dans Linux (bouton <strong>Upload</strong> dans lâ€™onglet <strong>Files</strong>) et on lâ€™importe en mÃ©moire</p>
<pre class="r"><code>df2 &lt;- readr::read_csv2(&quot;/data_post/example_encoding.csv&quot;)

df2</code></pre>
<p>A lâ€™affichage, les caractÃ¨res spÃ©ciaux ont Ã©tÃ© transformÃ©s en des caractÃ¨res â€œbizarresâ€.</p>
<p>Voici illustrÃ© en deux exemples, les problÃ¨mes dâ€™encodage que vous pourriez avoir.
Ce qui sâ€™est passÃ©, câ€™est que comme Linux et windows nâ€™utilise pas le mÃªme encodage par dÃ©faut, certains caractÃ¨res ont Ã©tÃ© mal retranscrits.</p>
</div>
</div>
<div id="bien-gÃ©rer-lencodage" class="section level1">
<h1>Bien gÃ©rer lâ€™encodage</h1>
<div id="a-la-lecture-des-donnÃ©es" class="section level2">
<h2>A la lecture des donnÃ©es</h2>
<p>La solution pour bien lire les donnÃ©es (que ce soit dans Linux ou Windows) est de spÃ©cifier lâ€™encodage qui a servi pour enregistrer les donnÃ©es.</p>
<div id="dans-excel" class="section level3">
<h3>Dans Excel</h3>
<p>Dans la premiÃ¨re illustration, il faut ouvrir le fichier csv dans excel en spÃ©cifiant UTF-8 comme encodage.</p>
<p>Pour cela, il faut ouvrir une page excel vierge puis aller dans <strong>DONNÃ‰ES &gt; Fichier texte</strong>.
SÃ©lectionnez votre fichier. Dans lâ€™assistant dâ€™importation de texte Ã  lâ€™Ã©tape 1 vous avez <strong>Origine du fichier</strong>. SÃ©lectionnez
<strong>65001 : Unicode (UTF-8)</strong> puis suivez le reste des Ã©tapes jusquâ€™Ã  la fin.</p>
<p>AprÃ¨s importation, les caractÃ¨res spÃ©ciaux devraient sâ€™afficher normalement.</p>
</div>
<div id="dans-linux" class="section level3">
<h3>Dans Linux</h3>
<p>Dans la deuxiÃ¨me illustration, il faut lire le fichier csv dans Linux en spÃ©cifiant <strong>WINDOWS-1252</strong> comme encodage.</p>
<pre class="r"><code>df2 &lt;- readr::read_csv2(&quot;/data_post/example_encoding.csv&quot;, locale = readr::locale(encoding = &quot;WINDOWS-1252&quot;))

df2</code></pre>
<blockquote>
<p>Presque toutes les fonctions de lecture de fichier dans R ont une option qui permet de spÃ©cifier lâ€™encodage (<code>fileEncoding</code> pour <code>read.\*</code>, <code>encoding</code> pour <code>fread</code>, <code>local</code> pour <code>read_*</code> â€¦)</p>
</blockquote>
<p>Vous pouvez aussi modifier lâ€™encodage des caractÃ¨res aprÃ¨s lecture avec <code>parse_character</code>.</p>
<pre class="r"><code>df2 &lt;- readr::read_csv2(&quot;/data_post/example_encoding.csv&quot;)

df2

# On change l&#39;encodage de tous les types caractÃ¨res
df2 &lt;- dplyr::mutate_all(df2, function(x){readr::parse_character(x, locale = readr::locale(encoding = &quot;WINDOWS-1252&quot;))})
df2</code></pre>
</div>
</div>
<div id="a-lÃ©criture-des-donnÃ©es" class="section level2">
<h2>A lâ€™Ã©criture des donnÃ©es</h2>
<p>A lâ€™Ã©criture des donnÃ©es vous avez deux choix possibles :</p>
<ul>
<li>SpÃ©cifier lâ€™encodage lors de lâ€™Ã©criture</li>
</ul>
<p>Pour faire cela nous allons utiliser les fonctions de base dans R <code>file</code> et <code>write.csv2</code></p>
<pre class="r"><code>con&lt;-file(&#39;df.csv&#39;,encoding=&quot;WINDOWS-1252&quot;)
write.csv2(df,file=con)</code></pre>
<blockquote>
<p>NOTE: Il nâ€™a pas Ã©tÃ© prÃ©vu la spÃ©cification de lâ€™encodage avec la fonction <code>write_csv2</code> de <code>readr</code> ni <code>fwrite</code> pour <code>data.table</code>. Ils Ã©crivent toujours en UTF-8. La requÃªte prÃ©cÃ©dente ne changera donc pas lâ€™encodage si vous utilisez <code>write_csv2</code> (<code>fwrite</code> ne prend pas de paramÃ¨tre de type <code>connection</code>).</p>
</blockquote>
<ul>
<li>Rajouter un Indicateur dâ€™ordre des octets (Byte Order Mark)</li>
</ul>
<p>En Unicode, <a href="https://fr.wikipedia.org/wiki/Indicateur_d%27ordre_des_octets">lâ€™indicateur dâ€™ordre des octets</a> ou BOM (pour lâ€™anglais byte order mark) est une donnÃ©e qui indique lâ€™utilisation dâ€™un encodage Unicode ainsi que lâ€™ordre des octets, gÃ©nÃ©ralement situÃ© au dÃ©but de certains fichiers texte.</p>
<p>Pour dire simple le BOM spÃ©cifie lors de lâ€™Ã©criture que le fichier est encodÃ© en Unicode (UTF-8 dans notre cas).</p>
<p>Pour faire cela, on utilise la fonction <code>write_excel_csv2</code> de <code>readr</code></p>
<pre class="r"><code>readr::write_excel_csv2(df, &quot;df-UTF8-BOM.csv&quot;)</code></pre>
<p>A lâ€™ouverture dans tout autre environnement (Excel bureau dans notre cas), Lâ€™encodage UTF-8 sera automatiquement utilisÃ©.</p>
</div>
</div>
<div id="et-mes-scripts-dans-tout-Ã§a" class="section level1">
<h1>Et mes scripts dans tout Ã§a ğŸ¤”?</h1>
<p>Si vous rÃ©digez/rÃ©cupÃ©rez des scripts rÃ©digÃ©s dans deux environnements diffÃ©rents (Rstudio en local sur votre poste Windows et Linux) vous aurez surement des soucis avec les caractÃ¨res spÃ©ciaux lors du passage dâ€™un environnement Ã  lâ€™autre.</p>
<p>Pour Ã©viter ces dÃ©sagrÃ©ments dans vos scripts, nous vous conseillons fortement de mettre lâ€™encodage UTF-8 par dÃ©faut sur votre Rstudio Linux et windows.</p>
<p>Pour le faire, allez dans <strong>Tools &gt; Global Option &gt; Code &gt; Saving &gt; Default text encoding</strong> et mettez UTF-8.</p>
<p>Si vous disposez dâ€™un script dÃ©jÃ  Ã©crit dans un autre encodage, vous pouvez le rÃ©ouvrir en spÃ©cifiant le bon encodage. Ouvrez le fichier puis allez dans <strong>File &gt; Reopen with encoding</strong>.</p>
<p>Vous pouvez ensuite faire <strong>File &gt; Save with encoding</strong> pour lâ€™enregistrer en UTF-8.</p>
</div>
<div id="nos-conseils" class="section level1">
<h1>Nos conseils ğŸ™‚</h1>
<blockquote>
<p>UTF-8, jâ€™utiliseraiâ€¦</p>
</blockquote>
<ul>
<li>RÃ©glez votre R local en UTF8</li>
<li>RÃ©glez lâ€™encodage Ã  la lecture de vos fichiers</li>
<li>Convertissez vos scripts en UTF-8 sâ€™ils ne le sont pas</li>
<li>Si vous rencontrez des problÃ¨mes de caractÃ¨res bizarres, câ€™est surement liÃ© Ã  un mauvais encodage utilisÃ© Ã  la lecture.</li>
<li>Dans R il y a des fonctions qui peuvent aider Ã  identifier lâ€™encodage si vous avez des doutes (<code>readr::guess_encoding</code> par exemple)</li>
</ul>
</div>
<div id="quelques-articles-sur-lencodage-dans-r" class="section level1">
<h1>Quelques articles sur lâ€™encodage dans R</h1>
<ul>
<li><a href="https://freakonometrics.hypotheses.org/52168">Unicode, UTF-8â€¦ la base de lâ€™encodage</a></li>
<li><a href="https://support.rstudio.com/hc/en-us/articles/200532197-Character-Encoding">Script Encoding</a></li>
<li><a href="https://kevinushey.github.io/blog/2018/02/21/string-encoding-and-r/">Write UTF-8 encoded content to a file</a></li>
<li><a href="https://readr.tidyverse.org/articles/locales.html#character">Character with <code>readr</code></a></li>
<li><a href="https://appsilon.com/writing-excel-formatted-csv-using-readrwrite_excel_csv2/">Writing excel formatted csv using <code>readr::write_excel_csv2</code></a></li>
<li><a href="https://irene.rbind.io/post/encoding-in-r/">Encoding in R</a></li>
</ul>
</div>
